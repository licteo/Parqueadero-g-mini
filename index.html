<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Control Parqueadero PRO - Estado Interactivo</title>
    
    <link rel="icon" type="image/png" href="icono.png">
    <link rel="apple-touch-icon" href="icono.png">
    <meta name="mobile-web-app-capable" content="yes">

    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', sans-serif; }
        body { background-color: #f4f7f9; padding: 15px; color: #333; }
        .container { max-width: 950px; margin: 0 auto; background: white; padding: 20px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        
        h1 { text-align: center; margin-bottom: 20px; color: #2c3e50; }
        #tituloReporte { display: none; text-align: center; text-transform: uppercase; margin-bottom: 15px; font-size: 18px; font-weight: bold; border-bottom: 2px solid #333; padding-bottom: 5px; }

        .form-card { background: #fff; padding: 15px; border: 1px solid #e1e8ed; border-radius: 10px; margin-bottom: 20px; }
        .form-group { margin-bottom: 12px; position: relative; }
        label { display: block; margin-bottom: 5px; font-weight: bold; font-size: 0.85rem; color: #555; }
        input, select { width: 100%; padding: 12px; border: 1px solid #ccd6dd; border-radius: 8px; font-size: 1rem; outline: none; }
        
        .btn-input-action { position: absolute; right: 5px; top: 26px; display: flex; gap: 5px; }
        .circle-btn { background: #ebf5fb; border: 1px solid #3498db; border-radius: 50%; width: 38px; height: 38px; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 1.1rem; }
        
        .form-row { display: flex; gap: 10px; }
        .form-row .form-group { flex: 1; }
        #btnRegistrar { width: 100%; padding: 14px; background: #3498db; color: white; border: none; border-radius: 8px; font-weight: bold; font-size: 1rem; cursor: pointer; margin-top: 10px; }

        .tool-bar { display: flex; justify-content: space-between; margin-bottom: 15px; gap: 10px; }
        .btn-tool { flex: 1; padding: 10px; border-radius: 8px; border: none; font-weight: bold; cursor: pointer; font-size: 0.8rem; text-align: center; }
        
        .filter-bar { display: flex; gap: 8px; overflow-x: auto; padding: 10px 0; margin-bottom: 10px; }
        .filter-btn { padding: 8px 16px; border: 1px solid #3498db; background: white; color: #3498db; border-radius: 20px; white-space: nowrap; font-size: 0.8rem; font-weight: 600; cursor: pointer; }
        .filter-btn.active { background: #3498db; color: white; }

        table { width: 100%; border-collapse: collapse; table-layout: fixed; margin-top: 10px; }
        th { background: #f8f9fa; font-size: 8px; font-weight: bold; border: 1px solid #333; padding: 4px; }
        td { border: 1px solid #333; padding: 5px 2px; text-align: center; font-size: 10px; word-wrap: break-word; vertical-align: middle; }
        
        .w-foto { width: 10%; }
        .w-prop { width: 14%; }
        .w-placa { width: 14%; font-weight: bold; }
        .w-ent { width: 16%; }
        .w-dias { width: 7%; font-weight: bold; }
        .w-obs { width: 22%; text-align: left !important; }
        .w-est { width: 17%; }

        .status-badge { padding: 4px 8px; border-radius: 12px; font-size: 9px; font-weight: bold; cursor: pointer; text-transform: uppercase; }
        .img-tabla { width: 100%; max-height: 45px; object-fit: cover; border-radius: 3px; }
        .btn-delete-row { background: none; border: none; color: #e74c3c; cursor: pointer; font-size: 1.1rem; margin-left: 5px; }

        @media print {
            .form-card, .filter-bar, .tool-bar, h1, .btn-input-action, .btn-delete-row { display: none !important; }
            #tituloReporte { display: block !important; }
            .container { max-width: 100%; width: 100%; border: none; padding: 0; }
            table { border: 2px solid #000; width: 100% !important; }
            th, td { color: black !important; border: 1px solid #000 !important; }
        }
    </style>
</head>
<body>

    <div class="container">
        <h1>üÖøÔ∏è Control Parqueadero PRO</h1>
        <div id="tituloReporte">REPORTE GENERAL</div>

        <section class="form-card">
            <div class="form-row">
                <div class="form-group" style="flex: 2;">
                    <label>Placa</label>
                    <input type="text" id="placa" style="text-transform:uppercase">
                    <div class="btn-input-action">
                        <button class="circle-btn" onclick="document.getElementById('inputCamara').click()">üì∏</button>
                        <button class="circle-btn" onclick="activarVoz('placa')">üé§</button>
                    </div>
                    <input type="file" id="inputCamara" accept="image/*" capture="camera" style="display:none" onchange="procesarFoto(this)">
                </div>
                <div class="form-group" style="flex: 1;">
                    <label>Estado</label>
                    <select id="estadoRegistro">
                        <option value="Pendiente">Pendiente ‚è≥</option>
                        <option value="Pagado">Pagado ‚úÖ</option>
                    </select>
                </div>
            </div>

            <div class="form-group">
                <label>Fecha y Hora (Opcional)</label>
                <input type="datetime-local" id="fechaManual">
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label>Propietario</label>
                    <input type="text" id="propietario">
                    <div class="btn-input-action"><button class="circle-btn" onclick="activarVoz('propietario')">üé§</button></div>
                </div>
                <div class="form-group">
                    <label>Categor√≠a</label>
                    <select id="categoria">
                        <option value="Moto Diario">Moto Diario</option>
                        <option value="Moto Mensual">Moto Mensual</option>
                        <option value="Buseta">Buseta</option>
                        <option value="Particular">Particular</option>
                        <option value="Pl√°sticos">Pl√°sticos</option>
                        <option value="Pintores">Pintores</option>
                    </select>
                </div>
            </div>

            <div class="form-group">
                <label>Observaciones / Cobro</label>
                <input type="text" id="observaciones">
                <div class="btn-input-action"><button class="circle-btn" onclick="activarVoz('observaciones', true)">üé§</button></div>
            </div>
            
            <button id="btnRegistrar" onclick="registrarVehiculo()">Registrar Entrada</button>
        </section>

        <div class="tool-bar">
            <button onclick="window.print()" class="btn-tool" style="background:#2ecc71; color:white;">üñ®Ô∏è Reporte</button>
            <button onclick="borrarTodo()" class="btn-tool" style="background:#95a5a6; color:white;">üßπ Limpiar</button>
        </div>

        <div class="filter-bar">
            <button class="filter-btn active" onclick="filtrar('Todas')">Todas</button>
            <button class="filter-btn" onclick="filtrar('Moto')">Motos</button>
            <button class="filter-btn" onclick="filtrar('Buseta')">Busetas</button>
            <button class="filter-btn" onclick="filtrar('Particular')">Particulares</button>
            <button class="filter-btn" onclick="filtrar('Pintores')">Pintores</button>
        </div>

        <table>
            <thead>
                <tr>
                    <th class="w-foto">FOTO</th>
                    <th class="w-prop">PROPIETARIO</th>
                    <th class="w-placa">PLACA</th>
                    <th class="w-ent">ENTRADA</th>
                    <th class="w-dias">D√çAS</th>
                    <th class="w-obs">OBSERVACIONES</th>
                    <th class="w-est">ESTADO</th>
                </tr>
            </thead>
            <tbody id="cuerpoTabla"></tbody>
        </table>
    </div>

    <script>
        let registros = JSON.parse(localStorage.getItem('parqueadero_db')) || [];
        let filtroActual = "Todas";
        let fotoTemp = "";

        function procesarFoto(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const img = new Image();
                    img.src = e.target.result;
                    img.onload = function() {
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        const MAX_W = 300;
                        const scale = MAX_W / img.width;
                        canvas.width = MAX_W;
                        canvas.height = img.height * scale;
                        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                        fotoTemp = canvas.toDataURL('image/jpeg', 0.6);
                        alert("Foto capturada ‚úÖ");
                    }
                }
                reader.readAsDataURL(input.files[0]);
            }
        }

        function activarVoz(id, esPrecio = false) {
            const recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
            recognition.lang = 'es-ES';
            recognition.onresult = (e) => {
                let texto = e.results[0][0].transcript.toLowerCase();
                if (esPrecio) {
                    texto = texto.replace(/ mil/g, '000').replace(/mil/g, '000').replace(/[^0-9]/g, '');
                    if (texto.length > 0) texto = parseInt(texto).toLocaleString('de-DE');
                }
                document.getElementById(id).value = texto.toUpperCase();
            };
            recognition.start();
        }

        function registrarVehiculo() {
            const placa = document.getElementById('placa').value.trim().toUpperCase();
            if(!placa) return alert("Ingrese una placa");

            if(registros.find(r => r.placa === placa)) {
                return alert(`‚ö†Ô∏è ¬°ALERTA!\nLa placa ${placa} ya est√° registrada.`);
            }

            let fechaEntrada = new Date();
            const valorManual = document.getElementById('fechaManual').value;
            if(valorManual) fechaEntrada = new Date(valorManual);

            const fechaTxt = fechaEntrada.toLocaleDateString([], {day:'2-digit', month:'2-digit'}) + " " + fechaEntrada.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit', hour12: true});

            registros.unshift({
                id: Date.now(),
                placa: placa,
                foto: fotoTemp,
                propietario: document.getElementById('propietario').value || "---",
                categoria: document.getElementById('categoria').value,
                observaciones: document.getElementById('observaciones').value || "---",
                entrada: fechaTxt,
                entradaRaw: fechaEntrada.getTime(),
                estado: document.getElementById('estadoRegistro').value // CAPTURA EL ESTADO ELEGIDO
            });

            localStorage.setItem('parqueadero_db', JSON.stringify(registros));
            fotoTemp = "";
            document.getElementById('placa').value = "";
            document.getElementById('propietario').value = "";
            document.getElementById('observaciones').value = "";
            document.getElementById('fechaManual').value = "";
            renderizar();
        }

        function alternarEstado(id) {
            registros = registros.map(r => {
                if(r.id === id) {
                    r.estado = r.estado.includes("Pendiente") ? "Pagado ‚úÖ" : "Pendiente ‚è≥";
                }
                return r;
            });
            localStorage.setItem('parqueadero_db', JSON.stringify(registros));
            renderizar();
        }

        function calcularDias(entradaRaw) {
            const diff = new Date().getTime() - entradaRaw;
            const dias = Math.floor(diff / (1000 * 60 * 60 * 24));
            return dias < 0 ? 0 : dias;
        }

        function filtrar(cat) {
            filtroActual = cat;
            document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
            event.target.classList.add('active');
            renderizar();
        }

        function darSalida(id) {
            if(confirm("¬øDar salida?")) {
                registros = registros.filter(r => r.id !== id);
                localStorage.setItem('parqueadero_db', JSON.stringify(registros));
                renderizar();
            }
        }

        function borrarTodo() {
            if(confirm("¬øBorrar todo?")) {
                registros = [];
                localStorage.setItem('parqueadero_db', JSON.stringify(registros));
                renderizar();
            }
        }

        function renderizar() {
            const cuerpo = document.getElementById('cuerpoTabla');
            cuerpo.innerHTML = "";
            const filtrados = registros.filter(r => filtroActual === "Todas" || r.categoria.includes(filtroActual));

            filtrados.forEach(reg => {
                const dias = calcularDias(reg.entradaRaw);
                const isPagado = reg.estado.includes("Pagado");
                
                cuerpo.innerHTML += `
                    <tr>
                        <td class="w-foto">${reg.foto ? `<img src="${reg.foto}" class="img-tabla">` : '---'}</td>
                        <td class="w-prop">${reg.propietario}</td>
                        <td class="w-placa">${reg.placa}</td>
                        <td class="w-ent">${reg.entrada}</td>
                        <td class="w-dias" style="${dias > 0 ? 'color:red; background:#fff9c4;' : ''}">${dias}</td>
                        <td class="w-obs">${reg.observaciones}</td>
                        <td class="w-est">
                            <span class="status-badge" 
                                  onclick="alternarEstado(${reg.id})"
                                  style="background:${isPagado ? '#d4edda':'#f8d7da'}; color:${isPagado ? '#155724':'#721c24'}">
                                ${reg.estado.split(' ')[0]}
                            </span>
                            <button class="btn-delete-row" onclick="darSalida(${reg.id})">üóëÔ∏è</button>
                        </td>
                    </tr>`;
            });
        }
        renderizar();
    </script>
</body>
</html>
